<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Store: Getting and Listening</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.2.0/redux.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/react-redux@8.0.1/dist/react-redux.min.js"></script>
    <script src='https://unpkg.com/babel-standalone@6.15.0/babel.min.js'></script>
   <script src="app.js" defer></script> 
</head>
<body>
    <div id="app"></div>
    <script type="text/babel">
        function List(props){
            const { items, removeItem, toggleItem } = props

            return <ul>
                {items.map((item =>
                {
                    return (
                    <li key={item.id}>
                        <span style={{ textDecoration: item.complete ? "line-through" : "none", color: item.complete ? "green": "red" }} onClick={() => toggleItem(item)}>{item.todoName||item.goalName}</span>
                        {removeItem && <button onClick={() => removeItem(item)}>X</button>}
                    </li>
                )}))}
            </ul>
        }

        //Presentational Componenent
        //They are concernd with how this look
        function Todos(props) {
            const { dispatch, todos } = props

            const inputRef = React.useRef(null);
            const addTodo = (e) => {
                e.preventDefault();
                const newTodo = inputRef.current.value
                inputRef.current.value = '';

                dispatch(createTodo({
                    id: generateID(),
                    todoName:  newTodo,
                    done: false
                }))
            }

            return (
                <div>
                    <h1>Todos</h1>
                    <input ref={inputRef} placeholder="Add a todo" />
                    <button type="button" onClick={addTodo}>Click Me!</button>
                    <List items={todos}/>
                </div>
            );
        }
        function Goals({ dispatch, goals }) {

            const inputRef = React.useRef(null);
            const addGoal = (e) => {
                e.preventDefault();

                const newGoal = inputRef.current.value
                inputRef.current.value = '';

                dispatch(createGoal({
                    id: generateID(),
                    goalName:  newGoal,
                    done: false
                }))
            }

            const handleRemoveItem = React.useCallback((item) => {

             dispatch(removeGoal(item.id))
            },[dispatch])

            const handleToggleItem = React.useCallback((item) => {

                dispatch(toggleGoal(item.id))
            },[dispatch])

            return (
                <div>
                    <h1>Goals</h1>
                    <input ref={ref => inputRef.current = ref} placeholder="Add a goal" />
                    <button type="button" onClick={addGoal}>Click Me!</button>
                    <List items={goals} removeItem={handleRemoveItem} toggleItem={handleToggleItem}/>
                </div>
            );
        }
        function App({ store }) {
 

            return (
                <div>
                    <ConnectedTodos />
                    <ConnectedGoals  />
                </div>
            );
        }

        /* Start Library Code*/
        const Context = React.createContext()

        function connect(mapStateToProps){
            return (Component) => {

                //Container Component
                //Container Component are concerned with how things work
                const Receiver = (props) => {
                    const { getState, dispatch, subscribe } = props.store
                    const [state, setState] = React.useState(getState())

                    React.useEffect(() => {
                
                        const unSubscribe = subscribe(() => {
                            setState(store.getState())
                        })
                        //run code here when the component unmounts
                        return () => {
                            unsubscribe();
                        }
                    }, [])

                    const stateNeeded = React.useMemo(() => mapStateToProps(state), [state])
                    return (
                        <Component { ...stateNeeded }  dispatch={dispatch}/>
                    )
                }

                //Container Component
                const ConnectedComponent = () => {
                    return (
                        <Context.Consumer>
                        {(store) => {
                            return <Receiver store={store} />
                        }}
                        </Context.Consumer>
                    )
                }

                return ConnectedComponent
            }
        }

        function Provider({store, children}){
            return (
                <Context.Provider value={store} >
                    {children}
                </Context.Provider>
            )
        }
        /* Endt Library Code*/

        /* Currying: Where you have functions that return funtions*/
        const ConnectedGoals = ReactRedux.connect((store) => {
            return {
                goals: store.goals
            }
        })(Goals)
        const ConnectedTodos = ReactRedux.connect((store) => ({ todos: store.todos}))(Todos)

        ReactDOM.render(<ReactRedux.Provider store={store}><App /></ReactRedux.Provider>, document.querySelector('#app'));
    </script>
</body>
</html>